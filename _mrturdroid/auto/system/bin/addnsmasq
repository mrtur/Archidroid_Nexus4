#!/system/bin/sh

# ArchiDroid Dnsmasq Fallback
# JustArchi@JustArchi.net
# Don't remove this file

# Set traps, kill dnsmasq, gently if possible
trap 'kill $pid; sleep 1; sh /system/etc/init.d/99ArchiDroid_Init "RELOAD" "ADBLOCK"; exit 0' ERR
trap 'kill $pid; sleep 1; sh /system/etc/init.d/99ArchiDroid_Init "RELOAD" "ADBLOCK"; exit 0' EXIT
trap 'kill $pid; sleep 1; sh /system/etc/init.d/99ArchiDroid_Init "RELOAD" "ADBLOCK"; exit 0' TERM
trap 'kill -3 $pid; sleep 1; sh /system/etc/init.d/99ArchiDroid_Init "RELOAD" "ADBLOCK"; exit 0' QUIT
trap 'kill -9 $pid; sleep 1; sh /system/etc/init.d/99ArchiDroid_Init "RELOAD" "ADBLOCK"; exit 0' KILL

# Turn off our Adblock, if turned on
sh /system/etc/init.d/99ArchiDroid_Init "STOP" "ADBLOCK"
sleep 1

# Start our better version of dnsmasq
archidroid_dnsmasq -S 208.67.222.222#5353 -S 208.67.220.220#5353 -S 8.8.8.8 -S 8.8.4.4 "$@" & # TODO: Handle through 99ArchiDroid_Init
pid=$!
wait $pid

exit 0